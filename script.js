document.addEventListener("mouseup", debounce(handleMouseUp, 100));

function handleMouseUp(event) {
    if (
        event.target.tagName === "INPUT" ||
        event.target.tagName === "TEXTAREA" ||
        event.target.isContentEditable
    ) {
        const existingPopup = document.getElementById("context-menu");
        if (existingPopup) existingPopup.remove();

        const selection = window.getSelection();
        if (selection.rangeCount > 0 && !selection.isCollapsed) {
            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            const selectedText = selection.toString();
            const popup = createPopup(rect, selectedText);

            document.body.appendChild(popup);

            popup.addEventListener("click", handlePopupClick, { once: true });
        }
    }
}

function createPopup(rect, selectedText) {
    const popup = document.createElement("div");
    popup.id = "context-menu";
    popup.style.top = `${rect.top + window.scrollY + 20}px`; // Adjust to avoid blocking text
    popup.style.left = `${rect.left + window.scrollX}px`;
    popup.style.position = "absolute"; // Ensure correct positioning
    popup.innerHTML = `
        <div id="context-menu-button-container">
            ${createButtonsHtml()}
        </div>
    `;
    return popup;
}

function createButtonsHtml() {
    const styles = [
        { dataStyle: "boldSans", title: "Bold Sans", text: "­ЮЌћ­ЮЌ«" },
        { dataStyle: "italicSans", title: "Italic Sans", text: "­Юўѕ­Юўб" },
        { dataStyle: "boldItalicSans", title: "Bold Italic Sans", text: "­Юў╝­ЮЎќ" },
        { dataStyle: "boldSerif", title: "Bold Serif", text: "­Юљђ­Юљџ" },
        {
            dataStyle: "italicBoldSerif",
            title: "Italic Bold Serif",
            text: "­ЮЉе­Юњѓ",
        },
        { dataStyle: "typewriter", title: "Typewriter", text: "­ЮЎ░­Юџі" },
        { dataStyle: "upsideDown", title: "Upside Down", text: "╔љРѕђ" },
        { dataStyle: "superscript", title: "Superscript", text: "р┤грхЃ" },
        { dataStyle: "subscript", title: "Subscript", text: "РѓљРѓљ" },
        { dataStyle: "strikethrough", title: "Strikethrough", text: " ╠ХA╠Хa╠Х" },
    ];

    return styles
        .map(
            (style) => `
        <button data-style="${style.dataStyle}" title="${style.title}">${style.text}</button>
    `
        )
        .join("");
}

function handlePopupClick(e) {
    const button = e.target.closest("button");
    if (button) {
        const style = button.getAttribute("data-style");
        const selection = window.getSelection();
        const range = selection.getRangeAt(0);
        const currentText = selection.toString();
        const styledText = applyStyle(currentText, style);

        // Replace selected text with styled text
        range.deleteContents();
        range.insertNode(document.createTextNode(styledText));

        // Update clipboard
        navigator.clipboard
            .writeText(styledText)
            .catch((err) => console.error("Failed to copy text: ", err));

        // Insert styled text into target element
        const targetElement = e.target.closest(
            "input, textarea, [contenteditable]"
        );
        if (targetElement) {
            if (
                targetElement.tagName === "TEXTAREA" ||
                targetElement.tagName === "INPUT"
            ) {
                const value = targetElement.value;
                const start = targetElement.selectionStart;
                const end = targetElement.selectionEnd;
                targetElement.value =
                    value.slice(0, start) + styledText + value.slice(end);
            } else if (targetElement.isContentEditable) {
                const originalContent = targetElement.innerHTML;
                targetElement.innerHTML = originalContent.replace(
                    new RegExp(currentText, "g"),
                    styledText
                );
            }
        }

        // Hide popup
        const popup = document.getElementById("context-menu");
        if (popup) popup.style.display = "none";
    }
}

function applyStyle(text, style) {
    const styleMap = styles[style] || {};

    if (style === "upsideDown") {
        // Reverse the text if the style is upsideDown
        text = text.split("").reverse().join("");
    }

    return text
        .split("")
        .map((char) => styleMap[char] || char)
        .join("");
}

function debounce(func, wait) {
    let timeout;
    return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

const styles = {
    boldSans: {
        A: "­ЮЌћ",
        B: "­ЮЌЋ",
        C: "­ЮЌќ",
        D: "­ЮЌЌ",
        E: "­ЮЌў",
        F: "­ЮЌЎ",
        G: "­ЮЌџ",
        H: "­ЮЌЏ",
        I: "­ЮЌю",
        J: "­ЮЌЮ",
        K: "­ЮЌъ",
        L: "­ЮЌЪ",
        M: "­ЮЌа",
        N: "­ЮЌА",
        O: "­ЮЌб",
        P: "­ЮЌБ",
        Q: "­ЮЌц",
        R: "­ЮЌЦ",
        S: "­ЮЌд",
        T: "­ЮЌД",
        U: "­ЮЌе",
        V: "­ЮЌЕ",
        W: "­ЮЌф",
        X: "­ЮЌФ",
        Y: "­ЮЌг",
        Z: "­ЮЌГ",
        a: "­ЮЌ«",
        b: "­ЮЌ»",
        c: "­ЮЌ░",
        d: "­ЮЌ▒",
        e: "­ЮЌ▓",
        f: "­ЮЌ│",
        g: "­ЮЌ┤",
        h: "­ЮЌх",
        i: "­ЮЌХ",
        j: "­ЮЌи",
        k: "­ЮЌИ",
        l: "­ЮЌ╣",
        m: "­ЮЌ║",
        n: "­ЮЌ╗",
        o: "­ЮЌ╝",
        p: "­ЮЌй",
        q: "­ЮЌЙ",
        r: "­ЮЌ┐",
        s: "­Юўђ",
        t: "­ЮўЂ",
        u: "­Юўѓ",
        v: "­ЮўЃ",
        w: "­Юўё",
        x: "­ЮўЁ",
        y: "­Юўє",
        z: "­ЮўЄ",
        0: "­ЮЪг",
        1: "­ЮЪГ",
        2: "­ЮЪ«",
        3: "­ЮЪ»",
        4: "­ЮЪ░",
        5: "­ЮЪ▒",
        6: "­ЮЪ▓",
        7: "­ЮЪ»",
        8: "­ЮЪ┤",
        9: "­ЮЪх",
    },
    italicSans: {
        A: "­Юўѕ",
        B: "­ЮўЅ",
        C: "­Юўі",
        D: "­ЮўІ",
        E: "­Юўї",
        F: "­ЮўЇ",
        G: "­Юўј",
        H: "­ЮўЈ",
        I: "­Юўљ",
        J: "­ЮўЉ",
        K: "­Юўњ",
        L: "­ЮўЊ",
        M: "­Юўћ",
        N: "­ЮўЋ",
        O: "­Юўќ",
        P: "­ЮўЌ",
        Q: "­Юўў",
        R: "­ЮўЎ",
        S: "­Юўџ",
        T: "­ЮўЏ",
        U: "­Юўю",
        V: "­ЮўЮ",
        W: "­Юўъ",
        X: "­ЮўЪ",
        Y: "­Юўа",
        Z: "­ЮўА",
        a: "­Юўб",
        b: "­ЮўБ",
        c: "­Юўц",
        d: "­ЮўЦ",
        e: "­Юўд",
        f: "­ЮўД",
        g: "­Юўе",
        h: "­ЮўЕ",
        i: "­Юўф",
        j: "­ЮўФ",
        k: "­Юўг",
        l: "­ЮўГ",
        m: "­Юў«",
        n: "­Юў»",
        o: "­Юў░",
        p: "­Юў▒",
        q: "­Юў▓",
        r: "­Юў│",
        s: "­Юў┤",
        t: "­Юўх",
        u: "­ЮўХ",
        v: "­Юўи",
        w: "­ЮўИ",
        x: "­Юў╣",
        y: "­Юў║",
        z: "­Юў╗",
        0: "0",
        1: "1",
        2: "2",
        3: "3",
        4: "4",
        5: "5",
        6: "6",
        7: "7",
        8: "8",
        9: "9",
    },
    boldItalicSans: {
        A: "­Юў╝",
        B: "­Юўй",
        C: "­ЮўЙ",
        D: "­Юў┐",
        E: "­ЮЎђ",
        F: "­ЮЎЂ",
        G: "­ЮЎѓ",
        H: "­ЮЎЃ",
        I: "­ЮЎё",
        J: "­ЮЎЁ",
        K: "­ЮЎє",
        L: "­ЮЎЄ",
        M: "­ЮЎѕ",
        N: "­ЮЎЅ",
        O: "­ЮЎі",
        P: "­ЮЎІ",
        Q: "­ЮЎї",
        R: "­ЮЎЇ",
        S: "­ЮЎј",
        T: "­ЮЎЈ",
        U: "­ЮЎљ",
        V: "­ЮЎЉ",
        W: "­ЮЎњ",
        X: "­ЮЎЊ",
        Y: "­ЮЎћ",
        Z: "­ЮЎЋ",
        a: "­ЮЎќ",
        b: "­ЮЎЌ",
        c: "­ЮЎў",
        d: "­ЮЎЎ",
        e: "­ЮЎџ",
        f: "­ЮЎЏ",
        g: "­ЮЎю",
        h: "­ЮЎЮ",
        i: "­ЮЎъ",
        j: "­ЮЎЪ",
        k: "­ЮЎа",
        l: "­ЮЎА",
        m: "­ЮЎб",
        n: "­ЮЎБ",
        o: "­ЮЎц",
        p: "­ЮЎЦ",
        q: "­ЮЎд",
        r: "­ЮЎД",
        s: "­ЮЎе",
        t: "­ЮЎЕ",
        u: "­ЮЎф",
        v: "­ЮЎФ",
        w: "­ЮЎг",
        x: "­ЮЎГ",
        y: "­ЮЎ«",
        z: "­ЮЎ»",
        0: "­ЮЪг",
        1: "­ЮЪГ",
        2: "­ЮЪ«",
        3: "­ЮЪ»",
        4: "­ЮЪ░",
        5: "­ЮЪ▒",
        6: "­ЮЪ▓",
        7: "­ЮЪ»",
        8: "­ЮЪ┤",
        9: "­ЮЪх",
    },
    boldSerif: {
        A: "­Юљђ",
        B: "­ЮљЂ",
        C: "­Юљѓ",
        D: "­ЮљЃ",
        E: "­Юљё",
        F: "­ЮљЁ",
        G: "­Юљє",
        H: "­ЮљЄ",
        I: "­Юљѕ",
        J: "­ЮљЅ",
        K: "­Юљі",
        L: "­ЮљІ",
        M: "­Юљї",
        N: "­ЮљЇ",
        O: "­Юљј",
        P: "­ЮљЈ",
        Q: "­Юљљ",
        R: "­ЮљЉ",
        S: "­Юљњ",
        T: "­ЮљЊ",
        U: "­Юљћ",
        V: "­ЮљЋ",
        W: "­Юљќ",
        X: "­ЮљЌ",
        Y: "­Юљў",
        Z: "­ЮљЎ",
        a: "­Юљџ",
        b: "­ЮљЏ",
        c: "­Юљю",
        d: "­ЮљЮ",
        e: "­Юљъ",
        f: "­ЮљЪ",
        g: "­Юља",
        h: "­ЮљА",
        i: "­Юљб",
        j: "­ЮљБ",
        k: "­Юљц",
        l: "­ЮљЦ",
        m: "­Юљд",
        n: "­ЮљД",
        o: "­Юље",
        p: "­ЮљЕ",
        q: "­Юљф",
        r: "­ЮљФ",
        s: "­Юљг",
        t: "­ЮљГ",
        u: "­Юљ«",
        v: "­Юљ»",
        w: "­Юљ░",
        x: "­Юљ▒",
        y: "­Юљ▓",
        z: "­Юљ│",
        0: "­ЮЪј",
        1: "­ЮЪЈ",
        2: "­ЮЪљ",
        3: "­ЮЪЉ",
        4: "­ЮЪњ",
        5: "­ЮЪЊ",
        6: "­ЮЪћ",
        7: "­ЮЪЋ",
        8: "­ЮЪќ",
        9: "­ЮЪЌ",
    },
    italicBoldSerif: {
        A: "­ЮЉе",
        B: "­ЮЉЕ",
        C: "­ЮЉф",
        D: "­ЮЉФ",
        E: "­ЮЉг",
        F: "­ЮЉГ",
        G: "­ЮЉ«",
        H: "­ЮЉ»",
        I: "­ЮЉ░",
        J: "­ЮЉ▒",
        K: "­ЮЉ▓",
        L: "­ЮЉ│",
        M: "­ЮЉ┤",
        N: "­ЮЉх",
        O: "­ЮЉХ",
        P: "­ЮЉи",
        Q: "­ЮЉИ",
        R: "­ЮЉ╣",
        S: "­ЮЉ║",
        T: "­ЮЉ╗",
        U: "­ЮЉ╝",
        V: "­ЮЉй",
        W: "­ЮЉЙ",
        X: "­ЮЉ┐",
        Y: "­Юњђ",
        Z: "­ЮњЂ",
        a: "­Юњѓ",
        b: "­ЮњЃ",
        c: "­Юњё",
        d: "­ЮњЁ",
        e: "­Юњє",
        f: "­ЮњЄ",
        g: "­Юњѕ",
        h: "­ЮњЅ",
        i: "­Юњі",
        j: "­ЮњІ",
        k: "­Юњї",
        l: "­ЮњЇ",
        m: "­Юњј",
        n: "­ЮњЈ",
        o: "­Юњљ",
        p: "­ЮњЉ",
        q: "­Юњњ",
        r: "­ЮњЊ",
        s: "­Юњћ",
        t: "­ЮњЋ",
        u: "­Юњќ",
        v: "­ЮњЌ",
        w: "­Юњў",
        x: "­ЮњЎ",
        y: "­Юњџ",
        z: "­ЮњЏ",
        0: "­ЮЪј",
        1: "­ЮЪЈ",
        2: "­ЮЪљ",
        3: "­ЮЪЉ",
        4: "­ЮЪњ",
        5: "­ЮЪЊ",
        6: "­ЮЪћ",
        7: "­ЮЪЋ",
        8: "­ЮЪќ",
        9: "­ЮЪЌ",
    },
    typewriter: {
        A: "­ЮЎ░",
        B: "­ЮЎ▒",
        C: "­ЮЎ▓",
        D: "­ЮЎ│",
        E: "­ЮЎ┤",
        F: "­ЮЎх",
        G: "­ЮЎХ",
        H: "­ЮЎи",
        I: "­ЮЎИ",
        J: "­ЮЎ╣",
        K: "­ЮЎ║",
        L: "­ЮЎ╗",
        M: "­ЮЎ╝",
        N: "­ЮЎй",
        O: "­ЮЎЙ",
        P: "­ЮЎ┐",
        Q: "­Юџђ",
        R: "­ЮџЂ",
        S: "­Юџѓ",
        T: "­ЮџЃ",
        U: "­Юџё",
        V: "­ЮџЁ",
        W: "­Юџє",
        X: "­ЮџЄ",
        Y: "­Юџѕ",
        Z: "­ЮџЅ",
        a: "­Юџі",
        b: "­ЮџІ",
        c: "­Юџї",
        d: "­ЮџЇ",
        e: "­Юџј",
        f: "­ЮџЈ",
        g: "­Юџљ",
        h: "­ЮџЉ",
        i: "­Юџњ",
        j: "­ЮџЊ",
        k: "­Юџћ",
        l: "­ЮџЋ",
        m: "­Юџќ",
        n: "­ЮџЌ",
        o: "­Юџў",
        p: "­ЮџЎ",
        q: "­Юџџ",
        r: "­ЮџЏ",
        s: "­Юџю",
        t: "­ЮџЮ",
        u: "­Юџъ",
        v: "­ЮџЪ",
        w: "­Юџа",
        x: "­ЮџА",
        y: "­Юџб",
        z: "­ЮџБ",
        0: "­ЮЪХ",
        1: "­ЮЪи",
        2: "­ЮЪИ",
        3: "­ЮЪ╣",
        4: "­ЮЪ║",
        5: "­ЮЪ╗",
        6: "­ЮЪ╝",
        7: "­ЮЪй",
        8: "­ЮЪЙ",
        9: "­ЮЪ┐",
    },
    upsideDown: {
        A: "Рѕђ",
        a: "╔љ",
        B: "q",
        b: "q",
        C: "кє",
        c: "╔ћ",
        D: "p",
        d: "p",
        E: "кј",
        e: "КЮ",
        F: "Рё▓",
        f: "╔Ъ",
        G: "Оц",
        g: "кЃ",
        H: "H",
        h: "╔Ц",
        I: "I",
        i: "р┤Ѕ",
        J: "┼┐",
        j: "╔Й",
        K: "╩ъ",
        k: "╩ъ",
        L: "╦Ц",
        l: "l",
        M: "W",
        m: "╔»",
        N: "N",
        n: "u",
        O: "O",
        o: "o",
        P: "нђ",
        p: "d",
        Q: "Q",
        q: "b",
        R: "╔╣",
        r: "╔╣",
        S: "S",
        s: "s",
        T: "Рћ┤",
        t: "╩Є",
        U: "РѕЕ",
        u: "n",
        V: "╬Џ",
        v: "╩ї",
        W: "M",
        w: "╩Ї",
        X: "X",
        x: "x",
        Y: "РЁё",
        y: "╩ј",
        Z: "Z",
        z: "z",
        0: "0",
        1: "кќ",
        2: "рёЁ",
        3: "кљ",
        4: "сёБ",
        5: "¤Џ",
        6: "9",
        7: "сёЦ",
        8: "8",
        9: "6",
    },
    superscript: {
        A: "р┤г",
        a: "рхЃ",
        B: "р┤«",
        b: "рхЄ",
        C: "рХю",
        c: "рХю",
        D: "р┤░",
        d: "рхѕ",
        E: "р┤▒",
        e: "рхЅ",
        F: "рХа",
        f: "рХа",
        G: "р┤│",
        g: "рхЇ",
        H: "р┤┤",
        h: "╩░",
        I: "р┤х",
        i: "рХд",
        J: "р┤Х",
        j: "╩▓",
        K: "р┤и",
        k: "рхЈ",
        L: "р┤И",
        l: "╦А",
        M: "р┤╣",
        m: "рхљ",
        N: "р┤║",
        n: "РЂ┐",
        O: "р┤╝",
        o: "рхњ",
        P: "р┤Й",
        p: "рхќ",
        Q: "рха",
        q: "рха",
        R: "р┤┐",
        r: "╩│",
        S: "╦б",
        s: "╦б",
        T: "рхђ",
        t: "рхЌ",
        U: "рхЂ",
        u: "рхў",
        V: "Р▒й",
        v: "рхЏ",
        W: "рхѓ",
        w: "╩и",
        X: "╦Б",
        x: "╦Б",
        Y: "╩И",
        y: "╩И",
        Z: "рХ╗",
        z: "рХ╗",
        0: "РЂ░",
        1: "┬╣",
        2: "┬▓",
        3: "┬│",
        4: "РЂ┤",
        5: "РЂх",
        6: "РЂХ",
        7: "РЂи",
        8: "РЂИ",
        9: "РЂ╣",
    },
    subscript: {
        A: "Рѓљ",
        a: "Рѓљ",
        B: "B",
        b: "b",
        C: "C",
        c: "c",
        D: "D",
        d: "d",
        E: "РѓЉ",
        e: "РѓЉ",
        F: "F",
        f: "f",
        G: "G",
        g: "g",
        H: "РѓЋ",
        h: "РѓЋ",
        I: "рхб",
        i: "рхб",
        J: "Р▒╝",
        j: "Р▒╝",
        K: "Рѓќ",
        k: "Рѓќ",
        L: "РѓЌ",
        l: "РѓЌ",
        M: "Рѓў",
        m: "Рѓў",
        N: "РѓЎ",
        n: "РѓЎ",
        O: "Рѓњ",
        o: "Рѓњ",
        P: "Рѓџ",
        p: "Рѓџ",
        Q: "Q",
        q: "q",
        R: "рхБ",
        r: "рхБ",
        S: "РѓЏ",
        s: "РѓЏ",
        T: "Рѓю",
        t: "Рѓю",
        U: "рхц",
        u: "рхц",
        V: "рхЦ",
        v: "рхЦ",
        W: "W",
        w: "w",
        X: "РѓЊ",
        x: "РѓЊ",
        Y: "Y",
        y: "y",
        Z: "Z",
        z: "z",
        0: "Рѓђ",
        1: "РѓЂ",
        2: "Рѓѓ",
        3: "РѓЃ",
        4: "Рѓё",
        5: "РѓЁ",
        6: "Рѓє",
        7: "РѓЄ",
        8: "Рѓѕ",
        9: "РѓЅ",
    },
    strikethrough: {
        A: "╠ХA╠Х",
        B: "╠ХB╠Х",
        C: "╠ХC╠Х",
        D: "╠ХD╠Х",
        E: "╠ХE╠Х",
        F: "╠ХF╠Х",
        G: "╠ХG╠Х",
        H: "╠ХH╠Х",
        I: "╠ХI╠Х",
        J: "╠ХJ╠Х",
        K: "╠ХK╠Х",
        L: "╠ХL╠Х",
        M: "╠ХM╠Х",
        N: "╠ХN╠Х",
        O: "╠ХO╠Х",
        P: "╠ХP╠Х",
        Q: "╠ХQ╠Х",
        R: "╠ХR╠Х",
        S: "╠ХS╠Х",
        T: "╠ХT╠Х",
        U: "╠ХU╠Х",
        V: "╠ХV╠Х",
        W: "╠ХW╠Х",
        X: "╠ХX╠Х",
        Y: "╠ХY╠Х",
        Z: "╠ХZ╠Х",
        a: "╠Хa╠Х",
        b: "╠Хb╠Х",
        c: "╠Хc╠Х",
        d: "╠Хd╠Х",
        e: "╠Хe╠Х",
        f: "╠Хf╠Х",
        g: "╠Хg╠Х",
        h: "╠Хh╠Х",
        i: "╠Хi╠Х",
        j: "╠Хj╠Х",
        k: "╠Хk╠Х",
        l: "╠Хl╠Х",
        m: "╠Хm╠Х",
        n: "╠Хn╠Х",
        o: "╠Хo╠Х",
        p: "╠Хp╠Х",
        q: "╠Хq╠Х",
        r: "╠Хr╠Х",
        s: "╠Хs╠Х",
        t: "╠Хt╠Х",
        u: "╠Хu╠Х",
        v: "╠Хv╠Х",
        w: "╠Хw╠Х",
        x: "╠Хx╠Х",
        y: "╠Хy╠Х",
        z: "╠Хz╠Х",
        0: "╠Х0╠Х",
        1: "╠Х1╠Х",
        2: "╠Х2╠Х",
        3: "╠Х3╠Х",
        4: "╠Х4╠Х",
        5: "╠Х5╠Х",
        6: "╠Х6╠Х",
        7: "╠Х7╠Х",
        8: "╠Х8╠Х",
        9: "╠Х9╠Х",
    },
};
