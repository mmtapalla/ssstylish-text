document.addEventListener("mouseup", debounce(handleMouseUp, 100));

function handleMouseUp(event) {
    if (
        event.target.tagName === "INPUT" ||
        event.target.tagName === "TEXTAREA" ||
        event.target.isContentEditable
    ) {
        const existingPopup = document.getElementById("context-menu");
        if (existingPopup) existingPopup.remove();

        const selection = window.getSelection();
        if (selection.rangeCount > 0 && !selection.isCollapsed) {
            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            const selectedText = selection.toString();
            const popup = createPopup(rect, selectedText);

            document.body.appendChild(popup);

            popup.addEventListener("click", handlePopupClick, { once: true });
        }
    }
}

function createPopup(rect, selectedText) {
    const popup = document.createElement("div");
    popup.id = "context-menu";
    popup.style.top = `${rect.top + window.scrollY + 20}px`; // Adjust to avoid blocking text
    popup.style.left = `${rect.left + window.scrollX}px`;
    popup.style.position = "absolute"; // Ensure correct positioning
    popup.innerHTML = `
        <div id="context-menu-button-container">
            ${createButtonsHtml()}
        </div>
    `;
    return popup;
}

function createButtonsHtml() {
    const styles = [
        { dataStyle: "boldSans", title: "Bold Sans", text: "ğ—”ğ—®" },
        { dataStyle: "italicSans", title: "Italic Sans", text: "ğ˜ˆğ˜¢" },
        { dataStyle: "boldItalicSans", title: "Bold Italic Sans", text: "ğ˜¼ğ™–" },
        { dataStyle: "boldSerif", title: "Bold Serif", text: "ğ€ğš" },
        {
            dataStyle: "italicBoldSerif",
            title: "Italic Bold Serif",
            text: "ğ‘¨ğ’‚",
        },
        { dataStyle: "typewriter", title: "Typewriter", text: "ğ™°ğšŠ" },
        { dataStyle: "upsideDown", title: "Upside Down", text: "Éâˆ€" },
        { dataStyle: "superscript", title: "Superscript", text: "á´¬áµƒ" },
        { dataStyle: "subscript", title: "Subscript", text: "â‚â‚" },
        { dataStyle: "strikethrough", title: "Strikethrough", text: " Ì¶AÌ¶aÌ¶" },
    ];

    return styles
        .map(
            (style) => `
        <button data-style="${style.dataStyle}" title="${style.title}">${style.text}</button>
    `
        )
        .join("");
}

function handlePopupClick(e) {
    const button = e.target.closest("button");
    if (button) {
        const style = button.getAttribute("data-style");
        const selection = window.getSelection();
        const range = selection.getRangeAt(0);
        const currentText = selection.toString();
        const styledText = applyStyle(currentText, style);

        // Replace selected text with styled text
        range.deleteContents();
        range.insertNode(document.createTextNode(styledText));

        // Update clipboard
        navigator.clipboard
            .writeText(styledText)
            .catch((err) => console.error("Failed to copy text: ", err));

        // Insert styled text into target element
        const targetElement = e.target.closest(
            "input, textarea, [contenteditable]"
        );
        if (targetElement) {
            if (
                targetElement.tagName === "TEXTAREA" ||
                targetElement.tagName === "INPUT"
            ) {
                const value = targetElement.value;
                const start = targetElement.selectionStart;
                const end = targetElement.selectionEnd;
                targetElement.value =
                    value.slice(0, start) + styledText + value.slice(end);
            } else if (targetElement.isContentEditable) {
                const originalContent = targetElement.innerHTML;
                targetElement.innerHTML = originalContent.replace(
                    new RegExp(currentText, "g"),
                    styledText
                );
            }
        }

        // Hide popup
        const popup = document.getElementById("context-menu");
        if (popup) popup.style.display = "none";
    }
}

function applyStyle(text, style) {
    const styleMap = styles[style] || {};

    if (style === "upsideDown") {
        // Reverse the text if the style is upsideDown
        text = text.split("").reverse().join("");
    }

    return text
        .split("")
        .map((char) => styleMap[char] || char)
        .join("");
}

function debounce(func, wait) {
    let timeout;
    return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

const styles = {
    boldSans: {
        A: "ğ—”",
        B: "ğ—•",
        C: "ğ—–",
        D: "ğ——",
        E: "ğ—˜",
        F: "ğ—™",
        G: "ğ—š",
        H: "ğ—›",
        I: "ğ—œ",
        J: "ğ—",
        K: "ğ—",
        L: "ğ—Ÿ",
        M: "ğ— ",
        N: "ğ—¡",
        O: "ğ—¢",
        P: "ğ—£",
        Q: "ğ—¤",
        R: "ğ—¥",
        S: "ğ—¦",
        T: "ğ—§",
        U: "ğ—¨",
        V: "ğ—©",
        W: "ğ—ª",
        X: "ğ—«",
        Y: "ğ—¬",
        Z: "ğ—­",
        a: "ğ—®",
        b: "ğ—¯",
        c: "ğ—°",
        d: "ğ—±",
        e: "ğ—²",
        f: "ğ—³",
        g: "ğ—´",
        h: "ğ—µ",
        i: "ğ—¶",
        j: "ğ—·",
        k: "ğ—¸",
        l: "ğ—¹",
        m: "ğ—º",
        n: "ğ—»",
        o: "ğ—¼",
        p: "ğ—½",
        q: "ğ—¾",
        r: "ğ—¿",
        s: "ğ˜€",
        t: "ğ˜",
        u: "ğ˜‚",
        v: "ğ˜ƒ",
        w: "ğ˜„",
        x: "ğ˜…",
        y: "ğ˜†",
        z: "ğ˜‡",
        0: "ğŸ¬",
        1: "ğŸ­",
        2: "ğŸ®",
        3: "ğŸ¯",
        4: "ğŸ°",
        5: "ğŸ±",
        6: "ğŸ²",
        7: "ğŸ¯",
        8: "ğŸ´",
        9: "ğŸµ",
    },
    italicSans: {
        A: "ğ˜ˆ",
        B: "ğ˜‰",
        C: "ğ˜Š",
        D: "ğ˜‹",
        E: "ğ˜Œ",
        F: "ğ˜",
        G: "ğ˜",
        H: "ğ˜",
        I: "ğ˜",
        J: "ğ˜‘",
        K: "ğ˜’",
        L: "ğ˜“",
        M: "ğ˜”",
        N: "ğ˜•",
        O: "ğ˜–",
        P: "ğ˜—",
        Q: "ğ˜˜",
        R: "ğ˜™",
        S: "ğ˜š",
        T: "ğ˜›",
        U: "ğ˜œ",
        V: "ğ˜",
        W: "ğ˜",
        X: "ğ˜Ÿ",
        Y: "ğ˜ ",
        Z: "ğ˜¡",
        a: "ğ˜¢",
        b: "ğ˜£",
        c: "ğ˜¤",
        d: "ğ˜¥",
        e: "ğ˜¦",
        f: "ğ˜§",
        g: "ğ˜¨",
        h: "ğ˜©",
        i: "ğ˜ª",
        j: "ğ˜«",
        k: "ğ˜¬",
        l: "ğ˜­",
        m: "ğ˜®",
        n: "ğ˜¯",
        o: "ğ˜°",
        p: "ğ˜±",
        q: "ğ˜²",
        r: "ğ˜³",
        s: "ğ˜´",
        t: "ğ˜µ",
        u: "ğ˜¶",
        v: "ğ˜·",
        w: "ğ˜¸",
        x: "ğ˜¹",
        y: "ğ˜º",
        z: "ğ˜»",
        0: "0",
        1: "1",
        2: "2",
        3: "3",
        4: "4",
        5: "5",
        6: "6",
        7: "7",
        8: "8",
        9: "9",
    },
    boldItalicSans: {
        A: "ğ˜¼",
        B: "ğ˜½",
        C: "ğ˜¾",
        D: "ğ˜¿",
        E: "ğ™€",
        F: "ğ™",
        G: "ğ™‚",
        H: "ğ™ƒ",
        I: "ğ™„",
        J: "ğ™…",
        K: "ğ™†",
        L: "ğ™‡",
        M: "ğ™ˆ",
        N: "ğ™‰",
        O: "ğ™Š",
        P: "ğ™‹",
        Q: "ğ™Œ",
        R: "ğ™",
        S: "ğ™",
        T: "ğ™",
        U: "ğ™",
        V: "ğ™‘",
        W: "ğ™’",
        X: "ğ™“",
        Y: "ğ™”",
        Z: "ğ™•",
        a: "ğ™–",
        b: "ğ™—",
        c: "ğ™˜",
        d: "ğ™™",
        e: "ğ™š",
        f: "ğ™›",
        g: "ğ™œ",
        h: "ğ™",
        i: "ğ™",
        j: "ğ™Ÿ",
        k: "ğ™ ",
        l: "ğ™¡",
        m: "ğ™¢",
        n: "ğ™£",
        o: "ğ™¤",
        p: "ğ™¥",
        q: "ğ™¦",
        r: "ğ™§",
        s: "ğ™¨",
        t: "ğ™©",
        u: "ğ™ª",
        v: "ğ™«",
        w: "ğ™¬",
        x: "ğ™­",
        y: "ğ™®",
        z: "ğ™¯",
        0: "ğŸ¬",
        1: "ğŸ­",
        2: "ğŸ®",
        3: "ğŸ¯",
        4: "ğŸ°",
        5: "ğŸ±",
        6: "ğŸ²",
        7: "ğŸ¯",
        8: "ğŸ´",
        9: "ğŸµ",
    },
    boldSerif: {
        A: "ğ€",
        B: "ğ",
        C: "ğ‚",
        D: "ğƒ",
        E: "ğ„",
        F: "ğ…",
        G: "ğ†",
        H: "ğ‡",
        I: "ğˆ",
        J: "ğ‰",
        K: "ğŠ",
        L: "ğ‹",
        M: "ğŒ",
        N: "ğ",
        O: "ğ",
        P: "ğ",
        Q: "ğ",
        R: "ğ‘",
        S: "ğ’",
        T: "ğ“",
        U: "ğ”",
        V: "ğ•",
        W: "ğ–",
        X: "ğ—",
        Y: "ğ˜",
        Z: "ğ™",
        a: "ğš",
        b: "ğ›",
        c: "ğœ",
        d: "ğ",
        e: "ğ",
        f: "ğŸ",
        g: "ğ ",
        h: "ğ¡",
        i: "ğ¢",
        j: "ğ£",
        k: "ğ¤",
        l: "ğ¥",
        m: "ğ¦",
        n: "ğ§",
        o: "ğ¨",
        p: "ğ©",
        q: "ğª",
        r: "ğ«",
        s: "ğ¬",
        t: "ğ­",
        u: "ğ®",
        v: "ğ¯",
        w: "ğ°",
        x: "ğ±",
        y: "ğ²",
        z: "ğ³",
        0: "ğŸ",
        1: "ğŸ",
        2: "ğŸ",
        3: "ğŸ‘",
        4: "ğŸ’",
        5: "ğŸ“",
        6: "ğŸ”",
        7: "ğŸ•",
        8: "ğŸ–",
        9: "ğŸ—",
    },
    italicBoldSerif: {
        A: "ğ‘¨",
        B: "ğ‘©",
        C: "ğ‘ª",
        D: "ğ‘«",
        E: "ğ‘¬",
        F: "ğ‘­",
        G: "ğ‘®",
        H: "ğ‘¯",
        I: "ğ‘°",
        J: "ğ‘±",
        K: "ğ‘²",
        L: "ğ‘³",
        M: "ğ‘´",
        N: "ğ‘µ",
        O: "ğ‘¶",
        P: "ğ‘·",
        Q: "ğ‘¸",
        R: "ğ‘¹",
        S: "ğ‘º",
        T: "ğ‘»",
        U: "ğ‘¼",
        V: "ğ‘½",
        W: "ğ‘¾",
        X: "ğ‘¿",
        Y: "ğ’€",
        Z: "ğ’",
        a: "ğ’‚",
        b: "ğ’ƒ",
        c: "ğ’„",
        d: "ğ’…",
        e: "ğ’†",
        f: "ğ’‡",
        g: "ğ’ˆ",
        h: "ğ’‰",
        i: "ğ’Š",
        j: "ğ’‹",
        k: "ğ’Œ",
        l: "ğ’",
        m: "ğ’",
        n: "ğ’",
        o: "ğ’",
        p: "ğ’‘",
        q: "ğ’’",
        r: "ğ’“",
        s: "ğ’”",
        t: "ğ’•",
        u: "ğ’–",
        v: "ğ’—",
        w: "ğ’˜",
        x: "ğ’™",
        y: "ğ’š",
        z: "ğ’›",
        0: "ğŸ",
        1: "ğŸ",
        2: "ğŸ",
        3: "ğŸ‘",
        4: "ğŸ’",
        5: "ğŸ“",
        6: "ğŸ”",
        7: "ğŸ•",
        8: "ğŸ–",
        9: "ğŸ—",
    },
    typewriter: {
        A: "ğ™°",
        B: "ğ™±",
        C: "ğ™²",
        D: "ğ™³",
        E: "ğ™´",
        F: "ğ™µ",
        G: "ğ™¶",
        H: "ğ™·",
        I: "ğ™¸",
        J: "ğ™¹",
        K: "ğ™º",
        L: "ğ™»",
        M: "ğ™¼",
        N: "ğ™½",
        O: "ğ™¾",
        P: "ğ™¿",
        Q: "ğš€",
        R: "ğš",
        S: "ğš‚",
        T: "ğšƒ",
        U: "ğš„",
        V: "ğš…",
        W: "ğš†",
        X: "ğš‡",
        Y: "ğšˆ",
        Z: "ğš‰",
        a: "ğšŠ",
        b: "ğš‹",
        c: "ğšŒ",
        d: "ğš",
        e: "ğš",
        f: "ğš",
        g: "ğš",
        h: "ğš‘",
        i: "ğš’",
        j: "ğš“",
        k: "ğš”",
        l: "ğš•",
        m: "ğš–",
        n: "ğš—",
        o: "ğš˜",
        p: "ğš™",
        q: "ğšš",
        r: "ğš›",
        s: "ğšœ",
        t: "ğš",
        u: "ğš",
        v: "ğšŸ",
        w: "ğš ",
        x: "ğš¡",
        y: "ğš¢",
        z: "ğš£",
        0: "ğŸ¶",
        1: "ğŸ·",
        2: "ğŸ¸",
        3: "ğŸ¹",
        4: "ğŸº",
        5: "ğŸ»",
        6: "ğŸ¼",
        7: "ğŸ½",
        8: "ğŸ¾",
        9: "ğŸ¿",
    },
    upsideDown: {
        A: "âˆ€",
        a: "É",
        B: "q",
        b: "q",
        C: "Æ†",
        c: "É”",
        D: "p",
        d: "p",
        E: "Æ",
        e: "Ç",
        F: "â„²",
        f: "ÉŸ",
        G: "×¤",
        g: "Æƒ",
        H: "H",
        h: "É¥",
        I: "I",
        i: "á´‰",
        J: "Å¿",
        j: "É¾",
        K: "Ê",
        k: "Ê",
        L: "Ë¥",
        l: "l",
        M: "W",
        m: "É¯",
        N: "N",
        n: "u",
        O: "O",
        o: "o",
        P: "Ô€",
        p: "d",
        Q: "Q",
        q: "b",
        R: "É¹",
        r: "É¹",
        S: "S",
        s: "s",
        T: "â”´",
        t: "Ê‡",
        U: "âˆ©",
        u: "n",
        V: "Î›",
        v: "ÊŒ",
        W: "M",
        w: "Ê",
        X: "X",
        x: "x",
        Y: "â…„",
        y: "Ê",
        Z: "Z",
        z: "z",
        0: "0",
        1: "Æ–",
        2: "á„…",
        3: "Æ",
        4: "ã„£",
        5: "Ï›",
        6: "9",
        7: "ã„¥",
        8: "8",
        9: "6",
    },
    superscript: {
        A: "á´¬",
        a: "áµƒ",
        B: "á´®",
        b: "áµ‡",
        C: "á¶œ",
        c: "á¶œ",
        D: "á´°",
        d: "áµˆ",
        E: "á´±",
        e: "áµ‰",
        F: "á¶ ",
        f: "á¶ ",
        G: "á´³",
        g: "áµ",
        H: "á´´",
        h: "Ê°",
        I: "á´µ",
        i: "á¶¦",
        J: "á´¶",
        j: "Ê²",
        K: "á´·",
        k: "áµ",
        L: "á´¸",
        l: "Ë¡",
        M: "á´¹",
        m: "áµ",
        N: "á´º",
        n: "â¿",
        O: "á´¼",
        o: "áµ’",
        P: "á´¾",
        p: "áµ–",
        Q: "áµ ",
        q: "áµ ",
        R: "á´¿",
        r: "Ê³",
        S: "Ë¢",
        s: "Ë¢",
        T: "áµ€",
        t: "áµ—",
        U: "áµ",
        u: "áµ˜",
        V: "â±½",
        v: "áµ›",
        W: "áµ‚",
        w: "Ê·",
        X: "Ë£",
        x: "Ë£",
        Y: "Ê¸",
        y: "Ê¸",
        Z: "á¶»",
        z: "á¶»",
        0: "â°",
        1: "Â¹",
        2: "Â²",
        3: "Â³",
        4: "â´",
        5: "âµ",
        6: "â¶",
        7: "â·",
        8: "â¸",
        9: "â¹",
    },
    subscript: {
        A: "â‚",
        a: "â‚",
        B: "B",
        b: "b",
        C: "C",
        c: "c",
        D: "D",
        d: "d",
        E: "â‚‘",
        e: "â‚‘",
        F: "F",
        f: "f",
        G: "G",
        g: "g",
        H: "â‚•",
        h: "â‚•",
        I: "áµ¢",
        i: "áµ¢",
        J: "â±¼",
        j: "â±¼",
        K: "â‚–",
        k: "â‚–",
        L: "â‚—",
        l: "â‚—",
        M: "â‚˜",
        m: "â‚˜",
        N: "â‚™",
        n: "â‚™",
        O: "â‚’",
        o: "â‚’",
        P: "â‚š",
        p: "â‚š",
        Q: "Q",
        q: "q",
        R: "áµ£",
        r: "áµ£",
        S: "â‚›",
        s: "â‚›",
        T: "â‚œ",
        t: "â‚œ",
        U: "áµ¤",
        u: "áµ¤",
        V: "áµ¥",
        v: "áµ¥",
        W: "W",
        w: "w",
        X: "â‚“",
        x: "â‚“",
        Y: "Y",
        y: "y",
        Z: "Z",
        z: "z",
        0: "â‚€",
        1: "â‚",
        2: "â‚‚",
        3: "â‚ƒ",
        4: "â‚„",
        5: "â‚…",
        6: "â‚†",
        7: "â‚‡",
        8: "â‚ˆ",
        9: "â‚‰",
    },
    strikethrough: {
        A: "Ì¶AÌ¶",
        B: "Ì¶BÌ¶",
        C: "Ì¶CÌ¶",
        D: "Ì¶DÌ¶",
        E: "Ì¶EÌ¶",
        F: "Ì¶FÌ¶",
        G: "Ì¶GÌ¶",
        H: "Ì¶HÌ¶",
        I: "Ì¶IÌ¶",
        J: "Ì¶JÌ¶",
        K: "Ì¶KÌ¶",
        L: "Ì¶LÌ¶",
        M: "Ì¶MÌ¶",
        N: "Ì¶NÌ¶",
        O: "Ì¶OÌ¶",
        P: "Ì¶PÌ¶",
        Q: "Ì¶QÌ¶",
        R: "Ì¶RÌ¶",
        S: "Ì¶SÌ¶",
        T: "Ì¶TÌ¶",
        U: "Ì¶UÌ¶",
        V: "Ì¶VÌ¶",
        W: "Ì¶WÌ¶",
        X: "Ì¶XÌ¶",
        Y: "Ì¶YÌ¶",
        Z: "Ì¶ZÌ¶",
        a: "Ì¶aÌ¶",
        b: "Ì¶bÌ¶",
        c: "Ì¶cÌ¶",
        d: "Ì¶dÌ¶",
        e: "Ì¶eÌ¶",
        f: "Ì¶fÌ¶",
        g: "Ì¶gÌ¶",
        h: "Ì¶hÌ¶",
        i: "Ì¶iÌ¶",
        j: "Ì¶jÌ¶",
        k: "Ì¶kÌ¶",
        l: "Ì¶lÌ¶",
        m: "Ì¶mÌ¶",
        n: "Ì¶nÌ¶",
        o: "Ì¶oÌ¶",
        p: "Ì¶pÌ¶",
        q: "Ì¶qÌ¶",
        r: "Ì¶rÌ¶",
        s: "Ì¶sÌ¶",
        t: "Ì¶tÌ¶",
        u: "Ì¶uÌ¶",
        v: "Ì¶vÌ¶",
        w: "Ì¶wÌ¶",
        x: "Ì¶xÌ¶",
        y: "Ì¶yÌ¶",
        z: "Ì¶zÌ¶",
        0: "Ì¶0Ì¶",
        1: "Ì¶1Ì¶",
        2: "Ì¶2Ì¶",
        3: "Ì¶3Ì¶",
        4: "Ì¶4Ì¶",
        5: "Ì¶5Ì¶",
        6: "Ì¶6Ì¶",
        7: "Ì¶7Ì¶",
        8: "Ì¶8Ì¶",
        9: "Ì¶9Ì¶",
    },
};
